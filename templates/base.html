{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Home{% endblock title %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="{% static 'fontawesome/css/all.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- <script>
        document.cookie = "csrftoken={{ csrf_token }}; path=/";
    </script> -->
    {% csrf_token %}
</head>
<body class="{% block body_bg %}{% endblock body_bg %}">
    <main>
        {% block content %}
        {% endblock %}
    </main>

    <div class="modal hidden" id="locationModal">
        <div class="modal-body absolute bottom-0 w-full lg:w-96 lg:left-[50%] lg:top-14 lg:bottom-auto lg:-translate-x-[50%]">
            <button role="button" id="closeBtn" class="close-btn block mx-auto size-10 rounded-full bg-black bg-opacity-35 text-white"><i class="fa-regular fa-xmark"></i></button>
            <div class="modal-content p-5 w-full bg-gray-200 mt-3 rounded-tl-xl rounded-tr-xl min-h-64 lg:rounded-lg">
                <div class="relative">
                    <input type="text" id="locsearch" placeholder="Search your area" class="w-full border-none bg-white rounded-lg p-3 outline-none">
                </div>
                <button role="button" id="getLocationBtn" class="text-primary mt-3 font-semibold cursor-pointer bg-white p-3 w-full rounded-lg flex justify-start items-center gap-2 relative">
                    <i class="fa-solid fa-location-crosshairs text-lg"></i>
                    Use my current location
                    <i class="fa-solid fa-angle-right text-lg absolute right-3 top-[14px] text-gray-500"></i>
                </button>
                <p id="output" class="mt-3"></p>
            </div>
        </div>
    </div>
    

    {% csrf_token %}

    <script src="{% static 'js/main.js' %}"></script>
    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        console.log(csrftoken);
        document.getElementById("getLocationBtn").addEventListener("click", () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(saveLocationObject, showError);
            } else {
                document.getElementById("output").innerText = "Geolocation is not supported!";
            }
        });

        function saveLocationObject(position) {
            const locationObj = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                updated_at: new Date().toISOString()
            };

            // Save as JSON object in localStorage
            localStorage.setItem("user_location", JSON.stringify(locationObj));

            $.ajax({
                url: "/select-location/",
                type: "POST",
                data: JSON.stringify(locationObj),
                contentType: "application/json",
                headers: {
                    "X-CSRFToken": csrftoken
                },
                success: function (response) {
                    console.log("Server:", response);
                    let data = JSON.parse(localStorage.getItem("user_location")) || {};
                    data.location_name = response.location
                    localStorage.setItem("user_location", JSON.stringify(data));
                },
                error: function (xhr) {
                    console.error(xhr.responseText);
                }
            });
        }

        function getCSRFToken() {
            let cookieValue = null;
            let cookies = document.cookie.split(";");

            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith("csrftoken=")) {
                    cookieValue = cookie.substring("csrftoken=".length);
                }
            }
            return cookieValue;
        }

        function showError(error) {
            document.getElementById("output").innerText =
                "Error getting location: " + error.message;
        }
    </script>
</body>
</html>